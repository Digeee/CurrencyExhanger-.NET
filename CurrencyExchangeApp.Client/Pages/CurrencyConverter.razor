@page "/converter"
@rendermode InteractiveWebAssembly
@inject IJSRuntime JSRuntime
@inject IUserPreferencesService UserPreferencesService
@using CurrencyExchangeApp.Client.Models
@using CurrencyExchangeApp.Client.Services
@using Microsoft.JSInterop

<PageTitle>Currency Converter</PageTitle>

<div class="currency-converter">
    <div class="container">
        <div class="converter-card card">
            <h1>ðŸ’± Currency Converter</h1>
            
            <!-- From Currency -->
            <div class="currency-input-group">
                <label for="fromAmount" class="form-label">From</label>
                <div class="input-group mb-3">
                    <input type="number" 
                           class="form-control form-control-lg" 
                           id="fromAmount" 
                           placeholder="Enter amount" 
                           @bind="fromAmount" 
                           @oninput="OnAmountChanged" />
                    <span class="input-group-text currency-symbol">@fromCurrency.Symbol</span>
                </div>
                
                <div class="currency-selector">
                    <button class="currency-btn" 
                            @onclick="() => ShowCurrencySelector(true)">
                        <div class="d-flex align-items-center">
                            <span class="flag-icon">@fromCurrency.FlagIcon</span>
                            <div>
                                <div class="currency-code">@fromCurrency.Code</div>
                                <div class="currency-name">@fromCurrency.Name</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Swap Button -->
            <div class="text-center">
                <button class="btn-swap" @onclick="SwapCurrencies">
                    <i class="bi bi-arrow-down-up"></i>
                </button>
            </div>
            
            <!-- To Currency -->
            <div class="currency-input-group">
                <label for="toAmount" class="form-label">To</label>
                <div class="input-group mb-3">
                    <input type="number" 
                           class="form-control form-control-lg" 
                           id="toAmount" 
                           placeholder="Converted amount" 
                           @bind="toAmount" 
                           readonly />
                    <span class="input-group-text currency-symbol">@toCurrency.Symbol</span>
                </div>
                
                <div class="currency-selector">
                    <button class="currency-btn" 
                            @onclick="() => ShowCurrencySelector(false)">
                        <div class="d-flex align-items-center">
                            <span class="flag-icon">@toCurrency.FlagIcon</span>
                            <div>
                                <div class="currency-code">@toCurrency.Code</div>
                                <div class="currency-name">@toCurrency.Name</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Exchange Rate Display -->
            <div class="exchange-rate-display">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="rate-label">Exchange Rate</div>
                        <div class="rate-value">1 @fromCurrency.Code = @exchangeRate @toCurrency.Code</div>
                    </div>
                    <div class="timestamp">
                        <small>Last updated: @DateTime.Now.ToString("HH:mm:ss")</small>
                    </div>
                </div>
            </div>
            
            <!-- Chart Section -->
            <div class="chart-container card mt-4">
                <h3>ðŸ“Š @fromCurrency.Code/@toCurrency.Code Historical Rates</h3>
                <div class="d-flex mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm">7D</button>
                        <button type="button" class="btn btn-outline-primary btn-sm">1M</button>
                        <button type="button" class="btn btn-outline-primary btn-sm">3M</button>
                        <button type="button" class="btn btn-outline-primary btn-sm">1Y</button>
                    </div>
                </div>
                <canvas id="exchangeRateChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Currency Selector Modal -->
<div class="modal fade currency-modal" id="currencySelectorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Currency</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="search-box mb-3">
                    <input type="text" class="form-control" placeholder="Search currencies..." @bind="searchTerm" @oninput="FilterCurrencies" />
                </div>
                <div class="currency-list">
                    @if (filteredCurrencies != null)
                    {
                        @foreach (var currency in filteredCurrencies)
                        {
                            <div class="currency-item" @onclick="() => SelectCurrency(currency)">
                                <div class="d-flex align-items-center">
                                    <span class="flag-icon me-3">@currency.FlagIcon</span>
                                    <div>
                                        <div class="currency-code">@currency.Code</div>
                                        <div class="currency-name">@currency.Name</div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    public ICurrencyExchangeService? CurrencyService { get; set; }
    
    private decimal fromAmount = 1;
    private decimal toAmount;
    private Currency fromCurrency = new() { Code = "USD", Name = "US Dollar", Symbol = "$", FlagIcon = "ðŸ‡ºðŸ‡¸" };
    private Currency toCurrency = new() { Code = "EUR", Name = "Euro", Symbol = "â‚¬", FlagIcon = "ðŸ‡ªðŸ‡º" };
    private decimal exchangeRate = 1;
    private List<Currency> currencies = new();
    private List<Currency> filteredCurrencies = new();
    private string searchTerm = "";
    private bool isSelectingFromCurrency = true;
    
    protected override async Task OnInitializedAsync()
    {
        // Load user preferences
        var preferences = UserPreferencesService.GetPreferences();
        fromCurrency = GetCurrencyByCode(preferences.DefaultFromCurrency) ?? fromCurrency;
        toCurrency = GetCurrencyByCode(preferences.DefaultToCurrency) ?? toCurrency;
        
        await LoadCurrenciesAsync();
        await ConvertCurrencyAsync();
        await LoadHistoricalDataAsync();
    }
    
    private async Task LoadCurrenciesAsync()
    {
        if (CurrencyService == null) return;
        
        try
        {
            currencies = await CurrencyService.GetAvailableCurrenciesAsync();
            filteredCurrencies = new List<Currency>(currencies);
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }
    
    private async Task ConvertCurrencyAsync()
    {
        if (CurrencyService == null) return;
        
        try
        {
            var result = await CurrencyService.ConvertCurrencyAsync(fromAmount, fromCurrency.Code, toCurrency.Code);
            toAmount = result;
            
            var rate = await CurrencyService.GetExchangeRateAsync(fromCurrency.Code, toCurrency.Code);
            exchangeRate = rate.Rate;
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }
    
    private async Task LoadHistoricalDataAsync()
    {
        if (CurrencyService == null) return;
        
        try
        {
            var historicalRates = await CurrencyService.GetHistoricalRatesAsync(fromCurrency.Code, toCurrency.Code, 7);
            var labels = historicalRates.Select(r => r.Date.ToString("MMM dd")).ToArray();
            var data = historicalRates.Select(r => (double)r.Rate).ToArray();
            
            await JSRuntime.InvokeVoidAsync("exchangeRateChartInterop.initializeExchangeRateChart", 
                "exchangeRateChart", labels, data);
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }
    
    private async Task OnAmountChanged(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString() ?? "0", out var amount))
        {
            fromAmount = amount;
            await ConvertCurrencyAsync();
        }
    }
    
    private async Task SwapCurrencies()
    {
        var temp = fromCurrency;
        fromCurrency = toCurrency;
        toCurrency = temp;
        await ConvertCurrencyAsync();
        await LoadHistoricalDataAsync();
    }
    
    private async Task ShowCurrencySelector(bool isFrom)
    {
        isSelectingFromCurrency = isFrom;
        searchTerm = "";
        filteredCurrencies = new List<Currency>(currencies);
        
        // Use JS interop to show the modal
        await InvokeAsync(async () => {
            await Task.Delay(100); // Small delay to ensure DOM is ready
            try
            {
                var modal = await JSRuntime.InvokeAsync<IJSObjectReference>("bootstrap.Modal.getOrCreateInstance", "#currencySelectorModal");
                await modal.InvokeVoidAsync("show");
            }
            catch
            {
                // Handle error
            }
        });
    }
    
    private void FilterCurrencies(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString()?.ToLower() ?? "";
        if (string.IsNullOrEmpty(searchTerm))
        {
            filteredCurrencies = new List<Currency>(currencies);
        }
        else
        {
            filteredCurrencies = currencies
                .Where(c => c.Code.ToLower().Contains(searchTerm) || 
                           c.Name.ToLower().Contains(searchTerm))
                .ToList();
        }
    }
    
    private async Task SelectCurrency(Currency currency)
    {
        if (isSelectingFromCurrency)
        {
            fromCurrency = currency;
        }
        else
        {
            toCurrency = currency;
        }
        
        // Use JS interop to hide the modal
        await InvokeAsync(async () => {
            try
            {
                var modal = await JSRuntime.InvokeAsync<IJSObjectReference>("bootstrap.Modal.getInstance", "#currencySelectorModal");
                await modal.InvokeVoidAsync("hide");
            }
            catch
            {
                // Handle error
            }
        });
        
        await ConvertCurrencyAsync();
        await LoadHistoricalDataAsync();
    }
    
    private Currency? GetCurrencyByCode(string code)
    {
        return currencies.FirstOrDefault(c => c.Code == code);
    }
}